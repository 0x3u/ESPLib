local Workspace = workspace
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local Esp = {
	Enabled = false,
	TeamCheck = false,
	MaxDistance = 1000,
	FontSize = 11,
	FadeOut = {
		OnDistance = false,
		OnDeath = false,
		OnLeave = false,
	},
	Options = {
		Teamcheck = false,
		TeamcheckRGB = Color3.fromRGB(0, 255, 0),
		Friendcheck = false,
		FriendcheckRGB = Color3.fromRGB(0, 255, 0),
		Highlight = false,
		HighlightRGB = Color3.fromRGB(255, 0, 0),
	},
	Drawing = {
		Chams = {
			Enabled = false,
			Thermal = false,
			FillRGB = Color3.fromRGB(243, 116, 166),
			Fill_Transparency = 100,
			OutlineRGB = Color3.fromRGB(220, 70, 140),
			Outline_Transparency = 100,
			VisibleCheck = false,
		},
		Names = {
			Enabled = false,
			RGB = Color3.fromRGB(255, 255, 255),
		},
		Flags = {
			Enabled = false,
		},
		Distances = {
			Enabled = false,
			Position = "Text",
			RGB = Color3.fromRGB(255, 255, 255),
		},
		Healthbar = {
			Enabled = false,
			HealthText = false,
			Lerp = false,
			HealthTextRGB = Color3.fromRGB(119, 120, 255),
			Width = 2.5,
			Gradient = false,
			GradientRGB1 = Color3.fromRGB(243, 116, 166),
			GradientRGB2 = Color3.fromRGB(240, 90, 150),
			GradientRGB3 = Color3.fromRGB(220, 70, 140),
		},
		Boxes = {
			Animate = false,
			RotationSpeed = 300,
			Gradient = false,
			GradientRGB1 = Color3.fromRGB(243, 116, 116),
			GradientRGB2 = Color3.fromRGB(0, 0, 0),
			GradientFill = false,
			GradientFillRGB1 = Color3.fromRGB(243, 116, 116),
			GradientFillRGB2 = Color3.fromRGB(0, 0, 0),
			Filled = {
				Enabled = false,
				Transparency = 0.75,
				RGB = Color3.fromRGB(0, 0, 0),
			},
			Full = {
				Enabled = false,
				RGB = Color3.fromRGB(255, 255, 255),
			},
			Corner = {
				Enabled = false,
				RGB = Color3.fromRGB(255, 255, 255),
			},
		},
	},
	Connections = {
		RunService = RunService,
	},
	Fonts = {},
}

local Euphoria = Esp.Connections
local lplayer = Players.LocalPlayer
local Cam = workspace.CurrentCamera
local RotationAngle, Tick = -45, tick()

local Functions = {}
do
	function Functions:Create(Class, Properties)
		local _Instance = typeof(Class) == "string" and Instance.new(Class) or Class
		for Property, Value in pairs(Properties) do
			_Instance[Property] = Value
		end
		return _Instance
	end

	function Functions:FadeOutOnDist(element, distance)
		local transparency = math.max(0.1, 1 - (distance / Esp.MaxDistance))
		if element:IsA("TextLabel") then
			element.TextTransparency = 1 - transparency
		elseif element:IsA("ImageLabel") then
			element.ImageTransparency = 1 - transparency
		elseif element:IsA("UIStroke") then
			element.Transparency = 1 - transparency
		elseif element:IsA("Frame") then
			element.BackgroundTransparency = 1 - transparency
		elseif element:IsA("Highlight") then
			element.FillTransparency = 1 - transparency
			element.OutlineTransparency = 1 - transparency
		end
	end
end

local ScreenGui = Functions:Create("ScreenGui", {
	Parent = CoreGui,
	Name = "ESPHolder",
})

local EspInstances = {}

local function CreateEsp(plr)
	if EspInstances[plr] then
		EspInstances[plr].Holder:Destroy()
		EspInstances[plr] = nil
	end

	local holder = Functions:Create("Folder", {
		Parent = ScreenGui,
		Name = plr.Name,
	})

	local Name = Functions:Create("TextLabel", {
		Parent = holder,
		BackgroundTransparency = 1,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Font = Enum.Font.Code,
		TextSize = Esp.FontSize,
		TextStrokeTransparency = 0,
		TextStrokeColor3 = Color3.fromRGB(0, 0, 0),
		RichText = true,
	})

	local Distance = Functions:Create("TextLabel", {
		Parent = holder,
		BackgroundTransparency = 1,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Font = Enum.Font.Code,
		TextSize = Esp.FontSize,
		TextStrokeTransparency = 0,
		TextStrokeColor3 = Color3.fromRGB(0, 0, 0),
		RichText = true,
	})

	local Box = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Color3.fromRGB(0, 0, 0),
		BackgroundTransparency = 1,
		BorderSizePixel = 0,
	})

	local Gradient1 = Functions:Create("UIGradient", {
		Parent = Box,
		Enabled = false,
		Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Esp.Drawing.Boxes.GradientFillRGB1),
			ColorSequenceKeypoint.new(1, Esp.Drawing.Boxes.GradientFillRGB2),
		}),
	})

	local Outline = Functions:Create("UIStroke", {
		Parent = Box,
		Enabled = false,
		Transparency = 0,
		Color = Color3.fromRGB(255, 255, 255),
		Thickness = 1,
		LineJoinMode = Enum.LineJoinMode.Miter,
	})

	local Gradient2 = Functions:Create("UIGradient", {
		Parent = Outline,
		Enabled = false,
		Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Esp.Drawing.Boxes.GradientRGB1),
			ColorSequenceKeypoint.new(1, Esp.Drawing.Boxes.GradientRGB2),
		}),
	})

	local Healthbar = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Color3.fromRGB(255, 255, 255),
		BackgroundTransparency = 0,
	})

	local BehindHealthbar = Functions:Create("Frame", {
		Parent = holder,
		ZIndex = -1,
		BackgroundColor3 = Color3.fromRGB(0, 0, 0),
		BackgroundTransparency = 0,
	})

	local HealthbarGradient = Functions:Create("UIGradient", {
		Parent = Healthbar,
		Enabled = Esp.Drawing.Healthbar.Gradient,
		Rotation = -90,
		Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Esp.Drawing.Healthbar.GradientRGB1),
			ColorSequenceKeypoint.new(0.5, Esp.Drawing.Healthbar.GradientRGB2),
			ColorSequenceKeypoint.new(1, Esp.Drawing.Healthbar.GradientRGB3),
		}),
	})

	local HealthText = Functions:Create("TextLabel", {
		Parent = holder,
		BackgroundTransparency = 1,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Font = Enum.Font.Code,
		TextSize = Esp.FontSize,
		TextStrokeTransparency = 0,
		TextStrokeColor3 = Color3.fromRGB(0, 0, 0),
	})

	local Chams = Functions:Create("Highlight", {
		Parent = holder,
		FillTransparency = 1,
		OutlineTransparency = 0,
		OutlineColor = Color3.fromRGB(119, 120, 255),
		DepthMode = "AlwaysOnTop",
	})

	local LeftTop = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local LeftSide = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local RightTop = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local RightSide = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local BottomSide = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local BottomDown = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local BottomRightSide = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})
	local BottomRightDown = Functions:Create("Frame", {
		Parent = holder,
		BackgroundColor3 = Esp.Drawing.Boxes.Corner.RGB,
	})

	local Flag1 = Functions:Create("TextLabel", {
		Parent = holder,
		BackgroundTransparency = 1,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Font = Enum.Font.Code,
		TextSize = Esp.FontSize,
		TextStrokeTransparency = 0,
		TextStrokeColor3 = Color3.fromRGB(0, 0, 0),
	})

	local Flag2 = Functions:Create("TextLabel", {
		Parent = holder,
		BackgroundTransparency = 1,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Font = Enum.Font.Code,
		TextSize = Esp.FontSize,
		TextStrokeTransparency = 0,
		TextStrokeColor3 = Color3.fromRGB(0, 0, 0),
	})

	EspInstances[plr] = {
		Holder = holder,
		Name = Name,
		Distance = Distance,
		Box = Box,
		Outline = Outline,
		Gradient1 = Gradient1,
		Gradient2 = Gradient2,
		Healthbar = Healthbar,
		BehindHealthbar = BehindHealthbar,
		HealthbarGradient = HealthbarGradient,
		HealthText = HealthText,
		Chams = Chams,
		LeftTop = LeftTop,
		LeftSide = LeftSide,
		RightTop = RightTop,
		RightSide = RightSide,
		BottomSide = BottomSide,
		BottomDown = BottomDown,
		BottomRightSide = BottomRightSide,
		BottomRightDown = BottomRightDown,
		Flag1 = Flag1,
		Flag2 = Flag2,
		Player = plr,
		CharacterAddedConnection = nil,
	}

	local function onCharacterAdded(character)
		repeat
			wait()
		until character:FindFirstChild("HumanoidRootPart")
	end

	EspInstances[plr].CharacterAddedConnection = plr.CharacterAdded:Connect(onCharacterAdded)
end

local function UpdateEsp()
	if not Esp.Enabled then
		for plr, esp in pairs(EspInstances) do
			esp.Box.Visible = false
			esp.Name.Visible = false
			esp.Distance.Visible = false
			esp.Healthbar.Visible = false
			esp.BehindHealthbar.Visible = false
			esp.HealthText.Visible = false
			esp.Chams.Enabled = false
			esp.LeftTop.Visible = false
			esp.LeftSide.Visible = false
			esp.BottomSide.Visible = false
			esp.BottomDown.Visible = false
			esp.RightTop.Visible = false
			esp.RightSide.Visible = false
			esp.BottomRightSide.Visible = false
			esp.BottomRightDown.Visible = false
			esp.Flag1.Visible = false
			esp.Flag2.Visible = false
		end
		return
	end

	for plr, esp in pairs(EspInstances) do
		if not plr or not plr.Parent then
			if esp.CharacterAddedConnection then
				esp.CharacterAddedConnection:Disconnect()
			end
			esp.Holder:Destroy()
			EspInstances[plr] = nil
			continue
		end

		if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") or not plr.Character:FindFirstChild("Humanoid") then
			esp.Box.Visible = false
			esp.Name.Visible = false
			esp.Distance.Visible = false
			esp.Healthbar.Visible = false
			esp.BehindHealthbar.Visible = false
			esp.HealthText.Visible = false
			esp.Chams.Enabled = false
			esp.LeftTop.Visible = false
			esp.LeftSide.Visible = false
			esp.BottomSide.Visible = false
			esp.BottomDown.Visible = false
			esp.RightTop.Visible = false
			esp.RightSide.Visible = false
			esp.BottomRightSide.Visible = false
			esp.BottomRightDown.Visible = false
			esp.Flag1.Visible = false
			esp.Flag2.Visible = false
			continue
		end

		local HRP = plr.Character.HumanoidRootPart
		local Humanoid = plr.Character.Humanoid
		local Pos, OnScreen = Cam:WorldToScreenPoint(HRP.Position)
		local Dist = (Cam.CFrame.Position - HRP.Position).Magnitude / 3.5714285714

		if OnScreen and Dist <= Esp.MaxDistance then
			local Size = HRP.Size.Y
			local scaleFactor = (Size * Cam.ViewportSize.Y) / (Pos.Z * 2)
			local w, h = 2.5 * scaleFactor, 3.8 * scaleFactor

			if Esp.FadeOut.OnDistance then
				Functions:FadeOutOnDist(esp.Box, Dist)
				Functions:FadeOutOnDist(esp.Outline, Dist)
				Functions:FadeOutOnDist(esp.Name, Dist)
				Functions:FadeOutOnDist(esp.Distance, Dist)
				Functions:FadeOutOnDist(esp.Healthbar, Dist)
				Functions:FadeOutOnDist(esp.BehindHealthbar, Dist)
				Functions:FadeOutOnDist(esp.HealthText, Dist)
				Functions:FadeOutOnDist(esp.LeftTop, Dist)
				Functions:FadeOutOnDist(esp.LeftSide, Dist)
				Functions:FadeOutOnDist(esp.BottomSide, Dist)
				Functions:FadeOutOnDist(esp.BottomDown, Dist)
				Functions:FadeOutOnDist(esp.RightTop, Dist)
				Functions:FadeOutOnDist(esp.RightSide, Dist)
				Functions:FadeOutOnDist(esp.BottomRightSide, Dist)
				Functions:FadeOutOnDist(esp.BottomRightDown, Dist)
				Functions:FadeOutOnDist(esp.Chams, Dist)
				Functions:FadeOutOnDist(esp.Flag1, Dist)
				Functions:FadeOutOnDist(esp.Flag2, Dist)
			end

			esp.Chams.Adornee = plr.Character
			esp.Chams.Enabled = Esp.Drawing.Chams.Enabled
			esp.Chams.FillColor = Esp.Drawing.Chams.FillRGB
			esp.Chams.OutlineColor = Esp.Drawing.Chams.OutlineRGB

			if Esp.Drawing.Chams.Thermal then
				local breathe_effect = math.atan(math.sin(tick() * 2)) * 2 / math.pi
				esp.Chams.FillTransparency = Esp.Drawing.Chams.Fill_Transparency * breathe_effect * 0.01
				esp.Chams.OutlineTransparency = Esp.Drawing.Chams.Outline_Transparency * breathe_effect * 0.01
			end

			if Esp.Drawing.Chams.VisibleCheck then
				esp.Chams.DepthMode = "Occluded"
			else
				esp.Chams.DepthMode = "AlwaysOnTop"
			end

			esp.LeftTop.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.LeftTop.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
			esp.LeftTop.Size = UDim2.new(0, w / 5, 0, 1)

			esp.LeftSide.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.LeftSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
			esp.LeftSide.Size = UDim2.new(0, 1, 0, h / 5)

			esp.BottomSide.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.BottomSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
			esp.BottomSide.Size = UDim2.new(0, 1, 0, h / 5)
			esp.BottomSide.AnchorPoint = Vector2.new(0, 5)

			esp.BottomDown.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.BottomDown.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
			esp.BottomDown.Size = UDim2.new(0, w / 5, 0, 1)
			esp.BottomDown.AnchorPoint = Vector2.new(0, 1)

			esp.RightTop.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.RightTop.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y - h / 2)
			esp.RightTop.Size = UDim2.new(0, w / 5, 0, 1)
			esp.RightTop.AnchorPoint = Vector2.new(1, 0)

			esp.RightSide.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.RightSide.Position = UDim2.new(0, Pos.X + w / 2 - 1, 0, Pos.Y - h / 2)
			esp.RightSide.Size = UDim2.new(0, 1, 0, h / 5)
			esp.RightSide.AnchorPoint = Vector2.new(0, 0)

			esp.BottomRightSide.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.BottomRightSide.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
			esp.BottomRightSide.Size = UDim2.new(0, 1, 0, h / 5)
			esp.BottomRightSide.AnchorPoint = Vector2.new(1, 1)

			esp.BottomRightDown.Visible = Esp.Drawing.Boxes.Corner.Enabled
			esp.BottomRightDown.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
			esp.BottomRightDown.Size = UDim2.new(0, w / 5, 0, 1)
			esp.BottomRightDown.AnchorPoint = Vector2.new(1, 1)

			esp.Box.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
			esp.Box.Size = UDim2.new(0, w, 0, h)

			if Esp.Drawing.Boxes.Filled.Enabled then
				esp.Box.Visible = true
				esp.Box.BackgroundColor3 = Esp.Drawing.Boxes.Filled.RGB
				esp.Box.BackgroundTransparency = Esp.Drawing.Boxes.Filled.Transparency
				esp.Box.BorderSizePixel = 0

				esp.Gradient1.Enabled = Esp.Drawing.Boxes.GradientFill
				if Esp.Drawing.Boxes.GradientFill then
					esp.Gradient1.Color = ColorSequence.new({
						ColorSequenceKeypoint.new(0, Esp.Drawing.Boxes.GradientFillRGB1),
						ColorSequenceKeypoint.new(1, Esp.Drawing.Boxes.GradientFillRGB2),
					})
				end

				esp.Outline.Enabled = false
			else
				esp.Box.Visible = false
				esp.Outline.Enabled = false
			end

			RotationAngle = RotationAngle + (tick() - Tick) * Esp.Drawing.Boxes.RotationSpeed * math.cos(math.pi / 4 * tick() - math.pi / 2)
			
			if Esp.Drawing.Boxes.Gradient or Esp.Drawing.Boxes.GradientFill then
				esp.Gradient1.Rotation = RotationAngle
				esp.Gradient2.Rotation = RotationAngle
			else
				esp.Gradient1.Rotation = -45
				esp.Gradient2.Rotation = -45
			end
			Tick = tick()

			local health = Humanoid.Health / Humanoid.MaxHealth
			esp.Healthbar.Visible = Esp.Drawing.Healthbar.Enabled
			esp.Healthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - health))
			esp.Healthbar.Size = UDim2.new(0, Esp.Drawing.Healthbar.Width, 0, h * health)

			esp.BehindHealthbar.Visible = Esp.Drawing.Healthbar.Enabled
			esp.BehindHealthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2)
			esp.BehindHealthbar.Size = UDim2.new(0, Esp.Drawing.Healthbar.Width, 0, h)

			if Esp.Drawing.Healthbar.HealthText then
				local healthPercentage = math.floor(Humanoid.Health / Humanoid.MaxHealth * 100)
				esp.HealthText.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - healthPercentage / 100) + 3)
				esp.HealthText.Text = tostring(healthPercentage)
				esp.HealthText.Visible = Humanoid.Health < Humanoid.MaxHealth
				if Esp.Drawing.Healthbar.Lerp then
					local color = health >= 0.75 and Color3.fromRGB(0, 255, 0) or health >= 0.5 and Color3.fromRGB(255, 255, 0) or health >= 0.25 and Color3.fromRGB(255, 170, 0) or Color3.fromRGB(255, 0, 0)
					esp.HealthText.TextColor3 = color
				else
					esp.HealthText.TextColor3 = Esp.Drawing.Healthbar.HealthTextRGB
				end
			end

			esp.Name.Visible = Esp.Drawing.Names.Enabled
			if Esp.Options.Friendcheck and lplayer:IsFriendsWith(plr.UserId) then
				esp.Name.Text = string.format('(<font color="rgb(%d, %d, %d)">F</font>) %s', Esp.Options.FriendcheckRGB.R * 255, Esp.Options.FriendcheckRGB.G * 255, Esp.Options.FriendcheckRGB.B * 255, plr.Name)
			else
				esp.Name.Text = string.format('(<font color="rgb(%d, %d, %d)">E</font>) %s', 255, 0, 0, plr.Name)
			end
			esp.Name.Position = UDim2.new(0, Pos.X, 0, Pos.Y - h / 2 - 9)

			if Esp.Drawing.Distances.Enabled then
				if Esp.Drawing.Distances.Position == "Bottom" then
					esp.Distance.Position = UDim2.new(0, Pos.X, 0, Pos.Y + h / 2 + 7)
					esp.Distance.Text = string.format("%d meters", math.floor(Dist))
					esp.Distance.Visible = true
				elseif Esp.Drawing.Distances.Position == "Text" then
					esp.Distance.Visible = false
					if Esp.Options.Friendcheck and lplayer:IsFriendsWith(plr.UserId) then
						esp.Name.Text = string.format('(<font color="rgb(%d, %d, %d)">F</font>) %s [%d]', Esp.Options.FriendcheckRGB.R * 255, Esp.Options.FriendcheckRGB.G * 255, Esp.Options.FriendcheckRGB.B * 255, plr.Name, math.floor(Dist))
					else
						esp.Name.Text = string.format('(<font color="rgb(%d, %d, %d)">E</font>) %s [%d]', 255, 0, 0, plr.Name, math.floor(Dist))
					end
				end
			end
		else
			esp.Box.Visible = false
			esp.Name.Visible = false
			esp.Distance.Visible = false
			esp.Healthbar.Visible = false
			esp.BehindHealthbar.Visible = false
			esp.HealthText.Visible = false
			esp.Chams.Enabled = false
			esp.LeftTop.Visible = false
			esp.LeftSide.Visible = false
			esp.BottomSide.Visible = false
			esp.BottomDown.Visible = false
			esp.RightTop.Visible = false
			esp.RightSide.Visible = false
			esp.BottomRightSide.Visible = false
			esp.BottomRightDown.Visible = false
			esp.Flag1.Visible = false
			esp.Flag2.Visible = false
		end
	end
end

local function CleanupEsp(plr)
	if EspInstances[plr] then
		if EspInstances[plr].CharacterAddedConnection then
			EspInstances[plr].CharacterAddedConnection:Disconnect()
		end
		EspInstances[plr].Holder:Destroy()
		EspInstances[plr] = nil
	end
end

local function SetupPlayerEsp(plr)
	if plr ~= lplayer then
		CreateEsp(plr)

		plr.CharacterAdded:Connect(function(character)
			wait(0.5)
			if EspInstances[plr] then
				EspInstances[plr].Chams.Adornee = character
			end
		end)
	end
end

for _, player in pairs(Players:GetPlayers()) do
	SetupPlayerEsp(player)
end

Players.PlayerAdded:Connect(function(player)
	SetupPlayerEsp(player)
end)

Players.PlayerRemoving:Connect(function(player)
	CleanupEsp(player)
end)

RunService.RenderStepped:Connect(UpdateEsp)

return Esp
