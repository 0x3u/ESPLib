local cloneref = cloneref or function(o) return o end
local Workspace = cloneref(game:GetService("Workspace"))
local RunService = cloneref(game:GetService("RunService"))
local Players = cloneref(game:GetService("Players"))
local CoreGui = game:GetService("CoreGui")
local Lighting = cloneref(game:GetService("Lighting"))

local ESP = {
    Enabled = true,
    MaxDistance = 1000,
    FontSize = 11,
    FadeOut = {
        OnDistance = true,
        OnDeath = true,
        OnLeave = true,
    },
    Drawing = {
        Chams = {
            Enabled  = true,
            Thermal = true,
            FillRGB = Color3.fromRGB(243, 116, 166),
            Fill_Transparency = 60,
            OutlineRGB = Color3.fromRGB(220, 70, 140),
            Outline_Transparency = 0,
            VisibleCheck = true,
        },
        Names = {
            Enabled = true,
            RGB = Color3.fromRGB(255, 255, 255),
        },
        Distances = {
            Enabled = true, 
            Position = "Text",
            RGB = Color3.fromRGB(255, 255, 255),
        },
        Healthbar = {
            Enabled = true,  
            HealthText = true, Lerp = false, HealthTextRGB = Color3.fromRGB(255, 255, 255),
            Width = 2.5,
            Gradient = true, GradientRGB1 = Color3.fromRGB(243, 116, 166), GradientRGB2 = Color3.fromRGB(240, 90, 150), GradientRGB3 = Color3.fromRGB(220, 70, 140), 
        },
        Boxes = {
            Animate = true,
            RotationSpeed = 300,
            Gradient = false, GradientRGB1 = Color3.fromRGB(243, 116, 116), GradientRGB2 = Color3.fromRGB(0, 0, 0), 
            GradientFill = true, GradientFillRGB1 = Color3.fromRGB(243, 116, 116), GradientFillRGB2 = Color3.fromRGB(0, 0, 0), 
            Filled = {
                Enabled = true,
                Transparency = 0.75,
                RGB = Color3.fromRGB(0, 0, 0),
            },
            Full = {
                Enabled = true,
                RGB = Color3.fromRGB(255, 255, 255),
            },
            Corner = {
                Enabled = true,
                RGB = Color3.fromRGB(255, 255, 255),
            },
        };
    };
}

local lplayer = Players.LocalPlayer
local Cam = Workspace.CurrentCamera
local RotationAngle, Tick = -45, tick()

local Functions = {}
do
    function Functions:Create(Class, Properties)
        local _Instance = typeof(Class) == 'string' and Instance.new(Class) or Class
        for Property, Value in pairs(Properties) do
            _Instance[Property] = Value
        end
        return _Instance;
    end

    function Functions:FadeOutOnDist(element, distance)
        local transparency = math.max(0.1, 1 - (distance / ESP.MaxDistance))
        if element:IsA("TextLabel") then
            element.TextTransparency = 1 - transparency
        elseif element:IsA("ImageLabel") then
            element.ImageTransparency = 1 - transparency
        elseif element:IsA("UIStroke") then
            element.Transparency = 1 - transparency
        elseif element:IsA("Frame") and (element.Name == "Healthbar" or element.Name == "BehindHealthbar") then
            element.BackgroundTransparency = 1 - transparency
        elseif element:IsA("Frame") then
            element.BackgroundTransparency = 1 - transparency
        elseif element:IsA("Highlight") then
            element.FillTransparency = 1 - transparency
            element.OutlineTransparency = 1 - transparency
        end;
    end;  
end;

do
    if CoreGui:FindFirstChild("ESPHolder") then
        CoreGui["ESPHolder"]:Destroy()
    end

    local ScreenGui = Functions:Create("ScreenGui", {
        Parent = CoreGui,
        Name = "ESPHolder",
    });

    local CreateESP = function(CharacterModel)
        if not CharacterModel then return end
        
        local GuiName = tostring(CharacterModel)
        if ScreenGui:FindFirstChild(GuiName) then ScreenGui[GuiName]:Destroy() end
        
        local ESPFolder = Functions:Create("Folder", {
            Parent = ScreenGui,
            Name = GuiName
        })
        
        local Name = Functions:Create("TextLabel", {Parent = ESPFolder, Name = "NameLabel", Position = UDim2.new(0.5, 0, 0, -11), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = ESP.FontSize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0), RichText = true})
        local Box = Functions:Create("Frame", {Parent = ESPFolder, Name = "Box", BackgroundColor3 = Color3.fromRGB(0, 0, 0), BackgroundTransparency = 0.75, BorderSizePixel = 0})
        local Gradient1 = Functions:Create("UIGradient", {Parent = Box, Enabled = ESP.Drawing.Boxes.GradientFill, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, ESP.Drawing.Boxes.GradientFillRGB1), ColorSequenceKeypoint.new(1, ESP.Drawing.Boxes.GradientFillRGB2)}})
        local Outline = Functions:Create("UIStroke", {Parent = Box, Enabled = ESP.Drawing.Boxes.Gradient, Transparency = 0, Color = Color3.fromRGB(255, 255, 255), LineJoinMode = Enum.LineJoinMode.Miter})
        local Gradient2 = Functions:Create("UIGradient", {Parent = Outline, Enabled = ESP.Drawing.Boxes.Gradient, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, ESP.Drawing.Boxes.GradientRGB1), ColorSequenceKeypoint.new(1, ESP.Drawing.Boxes.GradientRGB2)}})
        
        local Healthbar = Functions:Create("Frame", {Parent = ESPFolder, Name="Healthbar", BackgroundColor3 = Color3.fromRGB(255, 255, 255), BackgroundTransparency = 0})
        local BehindHealthbar = Functions:Create("Frame", {Parent = ESPFolder, Name="BehindHealthbar", ZIndex = -1, BackgroundColor3 = Color3.fromRGB(0, 0, 0), BackgroundTransparency = 0})
        local HealthbarGradient = Functions:Create("UIGradient", {Parent = Healthbar, Enabled = ESP.Drawing.Healthbar.Gradient, Rotation = -90, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, ESP.Drawing.Healthbar.GradientRGB1), ColorSequenceKeypoint.new(0.5, ESP.Drawing.Healthbar.GradientRGB2), ColorSequenceKeypoint.new(1, ESP.Drawing.Healthbar.GradientRGB3)}})
        local HealthText = Functions:Create("TextLabel", {Parent = ESPFolder, Name = "HealthText", Position = UDim2.new(0.5, 0, 0, 31), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = ESP.FontSize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0)})
        
        local Chams = Functions:Create("Highlight", {Parent = ESPFolder, Name = "Chams", FillTransparency = 1, OutlineTransparency = 0, OutlineColor = Color3.fromRGB(119, 120, 255), DepthMode = "AlwaysOnTop"})
        
        local LeftTop = Functions:Create("Frame", {Parent = ESPFolder, Name = "LeftTop", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local LeftSide = Functions:Create("Frame", {Parent = ESPFolder, Name = "LeftSide", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local RightTop = Functions:Create("Frame", {Parent = ESPFolder, Name = "RightTop", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local RightSide = Functions:Create("Frame", {Parent = ESPFolder, Name = "RightSide", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local BottomSide = Functions:Create("Frame", {Parent = ESPFolder, Name = "BottomSide", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local BottomDown = Functions:Create("Frame", {Parent = ESPFolder, Name = "BottomDown", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local BottomRightSide = Functions:Create("Frame", {Parent = ESPFolder, Name = "BottomRightSide", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})
        local BottomRightDown = Functions:Create("Frame", {Parent = ESPFolder, Name = "BottomRightDown", BackgroundColor3 = ESP.Drawing.Boxes.Corner.RGB, Position = UDim2.new(0, 0, 0, 0)})

        local Updater = function()
            local Connection;
            local function HideESP()
                Box.Visible = false
                Name.Visible = false
                Healthbar.Visible = false
                BehindHealthbar.Visible = false
                HealthText.Visible = false
                LeftTop.Visible = false
                LeftSide.Visible = false
                BottomSide.Visible = false
                BottomDown.Visible = false
                RightTop.Visible = false
                RightSide.Visible = false
                BottomRightSide.Visible = false
                BottomRightDown.Visible = false
                Chams.Enabled = false
                
                if not CharacterModel or not CharacterModel.Parent then
                    if Connection then Connection:Disconnect() end
                    if ESPFolder then ESPFolder:Destroy() end
                end
            end

            Connection = RunService.RenderStepped:Connect(function()
                if CharacterModel and CharacterModel.Parent and CharacterModel:FindFirstChild("HumanoidRootPart") and CharacterModel:FindFirstChild("Humanoid") then
                    if lplayer.Character and CharacterModel == lplayer.Character then
                        HideESP()
                        return
                    end

                    local HRP = CharacterModel.HumanoidRootPart
                    local Humanoid = CharacterModel.Humanoid
                    local Pos, OnScreen = Cam:WorldToScreenPoint(HRP.Position)
                    local Dist = (Cam.CFrame.Position - HRP.Position).Magnitude / 3.5714285714
                    
                    if OnScreen and Dist <= ESP.MaxDistance and Humanoid.Health > 0 then
                        local Size = HRP.Size.Y
                        local scaleFactor = (Size * Cam.ViewportSize.Y) / (Pos.Z * 2)
                        local w, h = 3 * scaleFactor, 4.5 * scaleFactor
                        
                        if ESP.FadeOut.OnDistance then
                            Functions:FadeOutOnDist(Box, Dist)
                            Functions:FadeOutOnDist(Outline, Dist)
                            Functions:FadeOutOnDist(Name, Dist)
                            Functions:FadeOutOnDist(Healthbar, Dist)
                            Functions:FadeOutOnDist(BehindHealthbar, Dist)
                            Functions:FadeOutOnDist(HealthText, Dist)
                            Functions:FadeOutOnDist(LeftTop, Dist)
                            Functions:FadeOutOnDist(LeftSide, Dist)
                            Functions:FadeOutOnDist(BottomSide, Dist)
                            Functions:FadeOutOnDist(BottomDown, Dist)
                            Functions:FadeOutOnDist(RightTop, Dist)
                            Functions:FadeOutOnDist(RightSide, Dist)
                            Functions:FadeOutOnDist(BottomRightSide, Dist)
                            Functions:FadeOutOnDist(BottomRightDown, Dist)
                            Functions:FadeOutOnDist(Chams, Dist)
                        end

                        do
                            Chams.Adornee = CharacterModel
                            Chams.Enabled = ESP.Drawing.Chams.Enabled
                            Chams.FillColor = ESP.Drawing.Chams.FillRGB
                            Chams.OutlineColor = ESP.Drawing.Chams.OutlineRGB
                            if ESP.Drawing.Chams.Thermal then
                                local breathe_effect = math.atan(math.sin(tick() * 2)) * 2 / math.pi
                                Chams.FillTransparency = (ESP.Drawing.Chams.Fill_Transparency / 100) * (1 - (breathe_effect * 0.1))
                                Chams.OutlineTransparency = ESP.Drawing.Chams.Outline_Transparency
                            end
                            Chams.DepthMode = ESP.Drawing.Chams.VisibleCheck and "Occluded" or "AlwaysOnTop"
                        end

                        do
                            LeftTop.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            LeftTop.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                            LeftTop.Size = UDim2.new(0, w / 5, 0, 1)
                            
                            LeftSide.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            LeftSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                            LeftSide.Size = UDim2.new(0, 1, 0, h / 5)
                            
                            BottomSide.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            BottomSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
                            BottomSide.Size = UDim2.new(0, 1, 0, h / 5)
                            BottomSide.AnchorPoint = Vector2.new(0, 5)
                            
                            BottomDown.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            BottomDown.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
                            BottomDown.Size = UDim2.new(0, w / 5, 0, 1)
                            BottomDown.AnchorPoint = Vector2.new(0, 1)
                            
                            RightTop.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            RightTop.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y - h / 2)
                            RightTop.Size = UDim2.new(0, w / 5, 0, 1)
                            RightTop.AnchorPoint = Vector2.new(1, 0)
                            
                            RightSide.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            RightSide.Position = UDim2.new(0, Pos.X + w / 2 - 1, 0, Pos.Y - h / 2)
                            RightSide.Size = UDim2.new(0, 1, 0, h / 5)
                            RightSide.AnchorPoint = Vector2.new(0, 0)
                            
                            BottomRightSide.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            BottomRightSide.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
                            BottomRightSide.Size = UDim2.new(0, 1, 0, h / 5)
                            BottomRightSide.AnchorPoint = Vector2.new(1, 1)
                            
                            BottomRightDown.Visible = ESP.Drawing.Boxes.Corner.Enabled
                            BottomRightDown.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
                            BottomRightDown.Size = UDim2.new(0, w / 5, 0, 1)
                            BottomRightDown.AnchorPoint = Vector2.new(1, 1)                                                            
                        end

                        do
                            Box.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                            Box.Size = UDim2.new(0, w, 0, h)
                            Box.Visible = ESP.Drawing.Boxes.Full.Enabled;
                            
                            if ESP.Drawing.Boxes.Filled.Enabled then
                                Box.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                                Box.BackgroundTransparency = ESP.Drawing.Boxes.GradientFill and ESP.Drawing.Boxes.Filled.Transparency or 1
                                Box.BorderSizePixel = 1
                            else
                                Box.BackgroundTransparency = 1
                            end
                            
                            RotationAngle = RotationAngle + (tick() - Tick) * ESP.Drawing.Boxes.RotationSpeed * math.cos(math.pi / 4 * tick() - math.pi / 2)
                            if ESP.Drawing.Boxes.Animate then
                                Gradient1.Rotation = RotationAngle
                                Gradient2.Rotation = RotationAngle
                            else
                                Gradient1.Rotation = -45
                                Gradient2.Rotation = -45
                            end
                            Tick = tick()
                        end

                        do
                            local health = math.clamp(Humanoid.Health / Humanoid.MaxHealth, 0, 1)
                            Healthbar.Visible = ESP.Drawing.Healthbar.Enabled;
                            Healthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - health))  
                            Healthbar.Size = UDim2.new(0, ESP.Drawing.Healthbar.Width, 0, h * health)  
                            
                            BehindHealthbar.Visible = ESP.Drawing.Healthbar.Enabled;
                            BehindHealthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2)  
                            BehindHealthbar.Size = UDim2.new(0, ESP.Drawing.Healthbar.Width, 0, h)

                            if ESP.Drawing.Healthbar.HealthText then
                                local healthPercentage = math.floor(Humanoid.Health / Humanoid.MaxHealth * 100)
                                HealthText.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - healthPercentage / 100) + 3)
                                HealthText.Text = tostring(healthPercentage)
                                HealthText.Visible = Humanoid.Health < Humanoid.MaxHealth
                                if ESP.Drawing.Healthbar.Lerp then
                                    local color = health >= 0.75 and Color3.fromRGB(0, 255, 0) or health >= 0.5 and Color3.fromRGB(255, 255, 0) or health >= 0.25 and Color3.fromRGB(255, 170, 0) or Color3.fromRGB(255, 0, 0)
                                    HealthText.TextColor3 = color
                                else
                                    HealthText.TextColor3 = ESP.Drawing.Healthbar.HealthTextRGB
                                end
                            end                        
                        end

                        do
                            Name.Visible = ESP.Drawing.Names.Enabled
                            local nameText = CharacterModel.Name
                            
                            if ESP.Drawing.Distances.Enabled then
                                nameText = string.format('%s [%d]', nameText, math.floor(Dist))
                            end
                            
                            Name.Text = string.format('(<font color="rgb(%d, %d, %d)">T</font>) %s', 255, 255, 255, nameText)
                            Name.Position = UDim2.new(0, Pos.X, 0, Pos.Y - h / 2 - 9)
                        end
                    else
                        HideESP();
                    end
                else
                    HideESP();
                end
            end)
        end
        coroutine.wrap(Updater)();
    end

    local function MonitorWorkspace()
        for _, v in pairs(Workspace:GetChildren()) do
            if v:IsA("Model") and v:FindFirstChild("Humanoid") then
                coroutine.wrap(CreateESP)(v)
            end
        end

        Workspace.ChildAdded:Connect(function(v)
            if v:IsA("Model") then
                local attempts = 0
                while attempts < 10 do
                    if v:FindFirstChild("Humanoid") then
                        coroutine.wrap(CreateESP)(v)
                        break
                    end
                    attempts = attempts + 1
                    task.wait(0.5)
                end
            end
        end)
    end
    
    MonitorWorkspace()
end
